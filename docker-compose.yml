name: sisfo-akademik-backend

services:
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
      POSTGRES_DB: devdb
    ports:
      - "55432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d devdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: dev
      RABBITMQ_DEFAULT_PASS: dev
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD-SHELL", "rabbitmq-diagnostics ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: jaeger
    restart: unless-stopped
    ports:
      - "16686:16686" # UI
      - "14268:14268" # HTTP Collector
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:16686 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  api-gateway:
    image: golang:1.25-alpine
    container_name: api-gateway
    command:
      ["sh", "-c", "cd /workspace/services/api-gateway && go run ./cmd/server"]
    working_dir: /workspace
    volumes:
      - ./:/workspace
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=api-gateway
      - APP_HTTP_PORT=8999
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_RATE_LIMIT_PER_MINUTE=60
      - APP_UPSTREAM_AUTH_URL=http://auth-service:9091
      - APP_UPSTREAM_ACADEMIC_URLS=http://academic-service:9092,http://academic-service-2:9092
      - APP_UPSTREAM_ATTENDANCE_URL=http://attendance-service:9093
      - APP_UPSTREAM_ASSESSMENT_URL=http://assessment-service:9094
      - APP_UPSTREAM_ADMISSION_URL=http://admission-service:9095
      - APP_UPSTREAM_FINANCE_URL=http://finance-service:9096
      - APP_UPSTREAM_NOTIFICATION_URL=http://notification-service:9097
      - APP_UPSTREAM_FILE_URL=http://file-service:9098
    ports:
      - "8999:8999"
    healthcheck:
      test:
        ["CMD-SHELL", "wget -qO- http://localhost:8999/api/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  # --- Service placeholders (sleeping containers for dev orchestration) ---
  auth-service:
    image: golang:1.25-alpine
    container_name: auth-service
    profiles: ["services"]
    working_dir: /workspace
    command: ["sh", "-c", "cd services/auth-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=auth-service
      - APP_HTTP_PORT=9091
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9091:9091"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD-SHELL", "wget -qO- http://localhost:9091/api/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  academic-service:
    image: golang:1.25-alpine
    container_name: academic-service
    profiles: ["services"]
    working_dir: /workspace
    command: ["sh", "-c", "cd services/academic-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=academic-service
      - APP_HTTP_PORT=9092
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9092:9092"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD-SHELL", "wget -qO- http://localhost:9092/api/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  academic-service-2:
    image: golang:1.25-alpine
    container_name: academic-service-2
    profiles: ["services"]
    working_dir: /workspace
    command: ["sh", "-c", "cd services/academic-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
    environment:
      - APP_SERVICE_NAME=academic-service-2
      - APP_HTTP_PORT=9092
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  attendance-service:
    build:
      context: .
      dockerfile: services/attendance-service/Dockerfile
    container_name: attendance-service
    profiles: ["services"]
    image: attendance-service:dev
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=attendance-service
      - APP_HTTP_PORT=9093
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9093:9093"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  assessment-service:
    build:
      context: .
      dockerfile: services/assessment-service/Dockerfile
    container_name: assessment-service
    profiles: ["services"]
    image: assessment-service:dev
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=assessment-service
      - APP_HTTP_PORT=9094
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9094:9094"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  admission-service:
    build:
      context: .
      dockerfile: services/admission-service/Dockerfile
    container_name: admission-service
    profiles: ["services"]
    image: admission-service:dev
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=admission-service
      - APP_HTTP_PORT=9095
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9095:9095"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  finance-service:
    image: golang:1.25-alpine
    container_name: finance-service
    profiles: ["services"]
    working_dir: /workspace
    command: ["sh", "-c", "cd services/finance-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
    environment:
      - APP_HTTP_PORT=9096
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9096:9096"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  notification-service:
    image: golang:1.25-alpine
    container_name: notification-service
    profiles: ["services"]
    working_dir: /workspace
    command:
      ["sh", "-c", "cd services/notification-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
    environment:
      - APP_HTTP_PORT=9097
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
    ports:
      - "9097:9097"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

  file-service:
    image: golang:1.25-alpine
    container_name: file-service
    profiles: ["services"]
    working_dir: /workspace
    command: ["sh", "-c", "cd services/file-service && go run ./cmd/server"]
    volumes:
      - ./:/workspace
      - ./uploads:/workspace/services/file-service/uploads
    environment:
      - APP_ENV=development
      - APP_SERVICE_NAME=file-service
      - APP_HTTP_PORT=9098
      - APP_POSTGRES_URL=postgres://dev:dev@postgres:5432/devdb?sslmode=disable
      - APP_REDIS_ADDR=redis:6379
      - APP_RABBIT_URL=amqp://dev:dev@rabbitmq:5672/
      - APP_JWT_ACCESS_SECRET=devaccess
      - APP_JWT_REFRESH_SECRET=devrefresh
      - APP_CORS_ALLOWED_ORIGINS=*,http://localhost:3000
      - APP_JWT_ISSUER=sisfo-akademik
      - APP_JWT_AUDIENCE=api
      - STORAGE_PATH=/workspace/services/file-service/uploads
    ports:
      - "9098:9098"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy

volumes:
  pgdata:
  rabbitmq-data:
